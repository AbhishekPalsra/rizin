#include <rz_search.h>
#include "minunit.h"

// TODO: move magic search code in rzsearch
// TODO: remove rz_search_reset
// TODO: remove rz_search_string_prepare_backward and include it in rzsearch
// TODO: test by using rz_search_find as well
// TODO: remove rz_search_update_i
// TODO: remove rz_search_set_mode, the mode shall be defined at creation time and that's it
// TODO: make sure rz_search_update actually does not modify the buffer
// TODO: refactor keyword search to use regexp search
// TODO: remove keyword from search string, privkey, aes
// TODO: improve code documentation
// TODO: test that keywords cannot be added to other types of rzsearch apart from KEYWORD
// TODO: test multiple updates
// TODO: test search across blocks
// TODO: check how to specify ranges

const ut8 rsa_private_4096[] = "\xff\x1c\x6a\x46\xe9\x4a\x43\x1b\x5b\xff\x51\x22\x99\x30\x82\x09\x28\x02\x01\x00\x02\x82\x02\x01\x00\xc0\x79\xf2\x4b\x04\x27\x87\xe4\x89\x6d\xb4\x11\xfa\x76\x47\xe3\xbb\x62\xc8\x87\x96\xfa\x97\x9f\x12\x6c\x57\x5f\x21\x1e\x80\xee\xda\xf8\x01\xcd\xe9\x1a\x39\x79\x08\x39\x58\x88\xd7\x96\x5c\xf4\x3d\x17\x12\xe4\xf5\x75\x08\x63\xc7\xa4\xe1\x39\x1c\xe3\xa5\x17\xce\xb2\xc2\x16\x81\xb1\x79\x92\xfa\x79\x13\x65\x74\x9b\x2d\xd6\xe9\x8a\x85\xf6\x37\x8b\x24\x36\x7e\x46\x90\x8e\x51\xf0\x8c\x64\x93\xdb\x49\xe0\xd9\x36\x9d\x0c\x35\x3b\x9f\x47\xfc\x0e\xdc\xc9\x02\x33\x34\xb8\x5a\xc7\x19\x63\x49\xf1\xeb\xd7\xab\xd9\xfb\xe8\xf6\x48\xf5\xfb\x32\xc2\xf6\xa3\x99\x8a\x09\xea\x84\x59\x18\xb3\x04\x48\xb7\x60\x8b\x2c\x56\x4d\x71\x73\x79\x23\x00\xe7\x84\x43\x69\xa0\x0c\x0b\xc7\xe5\x8f\x30\xfc\xb8\xb3\x56\xf3\xf7\x30\x1b\x6b\x01\x03\x28\x4d\x95\x86\x54\x89\xa3\xd2\x88\x6b\x9a\x08\xb5\x2f\x29\xe4\xf9\xe5\xa2\xe5\xdf\x90\x7f\x0b\xf7\x35\x83\x23\xca\x69\xb8\xb2\x5a\xa2\x21\x12\xd2\x14\x35\xd1\x55\x70\x01\x2d\xf9\xb0\x6e\x19\xd2\x3e\x22\x1e\x8b\x0c\xa6\xb3\x3e\x0c\x9c\xe2\xb3\xd3\xbe\x5a\xdb\x93\xdd\xf7\x37\x7f\x30\xb2\x16\x0e\xa4\xbe\xac\xc7\x6e\x0d\x83\x1d\xb4\x91\x77\xa5\xa8\x59\x03\x74\x4b\x4f\x18\xef\x2f\x01\x07\x70\x1b\x41\xed\x93\x98\x01\x08\x4a\xca\x78\xff\x08\x25\x38\xa8\xb8\xe6\x4a\x34\x4e\xdb\x4c\x28\x15\x37\xeb\x26\xd8\x4d\xe9\x36\x57\xdd\xf6\xfd\x33\xb7\x4b\xa9\x0e\xa8\xf3\x7b\x9f\xbf\xc0\x0b\xee\x16\x7d\x59\x60\xb7\xf3\x59\x37\x70\xb5\x71\x7f\x1a\xfe\xb2\x0b\x3a\x0a\xc3\xfa\x7a\x58\x22\x33\x43\x0e\xd4\xbc\x40\xe2\xe2\x9e\xc0\xf0\xc2\x8c\xce\xae\x8b\x26\xa7\xe4\x0d\xfe\x5b\x7e\xf9\x04\x03\x13\xb9\x07\x66\xf1\xbe\x37\xce\x48\x42\x28\xde\xf4\xc6\xfa\x88\x63\x6e\xf0\x51\x25\x21\xc8\x35\x3f\xd6\xf9\x9b\x2e\x09\xc7\x8e\xf6\x7d\xc4\x13\xc0\x1d\x09\x9e\x94\x2a\x3c\x2c\x35\x1e\xad\x9c\xbb\xfc\x5e\xfb\xeb\xcc\x43\x02\xf7\x71\xf3\x2f\x22\x4b\x84\x2b\x26\x8d\xc4\x48\xcf\x43\x12\xf5\x1d\xc0\x2e\x16\x80\x89\xba\x9d\x35\x17\xef\x00\xa9\x90\xae\x20\x48\x64\x31\x4f\x09\xc7\x6b\x46\x65\xbe\xb1\x2b\x9f\xbf\x0c\x41\x9f\xdc\x08\x00\x58\xab\x48\x4c\xe1\x54\x87\x3e\x9a\x56\x3f\xe3\x3c\x3c\xa9\xea\x9d\x00\x3a\xf4\xe9\x56\x6d\x41\x38\x30\x75\x1c\x57\x85\x02\x03\x01\x00\x01\x02\x82\x02\x01\x00\xad\x93\xcb\xdb\xb6\xed\x67\x71\xc4\x35\xf8\xb4\x55\xe9\x21\x3f\xd0\x97\x6f\x3c\x47\xfd\xc9\x8a\x9c\xf4\xb3\x7e\x88\xc1\x97\x88\xd0\x53\xe4\x5c\xab\xa1\x08\xbf\x8b\x99\x1b\xac\x9c\xaf\x6f\x38\x9b\x77\x19\x84\xfd\x8f\x03\x77\xe8\x6d\x5a\xe7\x44\x94\x4f\x28\x3f\x31\x9a\x32\xed\xd6\xfd\x4a\x7d\x33\x7f\x38\x79\x86\x10\x3a\xc5\xf6\x34\x85\x2c\xe6\x00\x4c\x5c\x68\x8a\xa8\xae\x60\x7e\x5b\x9d\xb3\x9e\xd6\x75\x4c\xf9\x28\x2f\x41\x8b\x8d\x41\x54\xad\xeb\x60\x5e\x89\x66\xd0\x06\xc9\x70\x6f\x19\x0a\x95\x3e\xd7\xa0\x84\x20\xc6\xff\x7d\xff\xf3\x2e\xb5\xaf\x1b\x7b\x81\xd0\xc5\x00\xaf\x40\x67\xcb\x67\xf7\x5a\x8e\xa1\xdc\x74\x44\x84\x3a\xa6\x8e\xf2\xb4\x68\xaf\x34\x58\x9b\x3f\x1c\xf0\x6c\x28\xdf\x7b\xb8\x29\xdc\x30\x0d\x83\xa9\x6e\xfe\x2f\x5c\x41\x9c\x49\x9a\xd9\x5e\xda\x07\x7b\x77\x0e\x96\x06\x6f\x77\x5a\xbc\x56\xb6\x95\xc3\xde\x76\x02\x6e\x81\x2f\xe6\xe8\x5b\x67\x3b\xa9\x1a\x37\xa4\x13\x14\x1d\x40\x15\xc9\xd4\xe3\x73\x41\x15\xc6\x54\x2c\x69\x6c\xc5\xb7\x1e\x03\x0a\x2b\x9a\x88\x76\xbb\x2f\xdd\x0e\x88\xfd\xb1\x42\x97\x73\x93\x90\x8c\xc5\x3f\xa9\x50\x01\x90\xc5\x21\x1c\x8d\xe7\x1d\xfd\xac\x26\x02\xa4\x5a\x53\xe7\xcf\xbe\x80\xd7\x93\xe9\x34\xf0\x5b\xdb\x89\x9a\x7b\xe8\xf0\x7e\x18\x19\x00\x48\xf8\x45\x9c\x6a\x19\xbf\x6c\x32\x04\xeb\x82\x8a\x0f\x7a\x0c\x54\xdb\x91\xe1\x29\x5c\xf4\xc8\xfe\xef\xaa\xa6\x1d\xc8\x95\x35\xfe\x40\x79\x1d\xd2\x7c\xe8\x6d\xb5\x03\x23\x5a\xfa\x5f\x89\x06\xeb\x3c\x63\x72\xae\xb2\xb6\xbb\x74\x91\xc0\x9f\xa0\x0a\x6a\x7b\xcc\x45\x1f\x83\xb3\x7d\x1f\x7d\xd1\x79\x63\x9a\x1d\x37\x9f\xfc\x6c\x5c\xbf\x86\xf4\xab\xc5\xcc\x9a\x90\xd9\x9c\xb5\x09\x6f\xc1\x17\x03\xcb\x49\xd2\x13\xe7\x73\x0c\xe2\x90\x7d\x39\x24\xc2\x03\xd2\x53\x2e\x3f\x06\x84\xd9\x70\xed\x61\xad\x90\x9a\xc3\xe5\x51\x21\x95\xb0\x7a\x9f\xaa\x0e\x3d\xac\x64\x4f\x44\x62\x6b\x51\xa1\x9e\x28\xf2\x3a\xde\x45\xed\xb7\xa4\x95\x3a\xaa\x38\x1d\x0d\x32\x54\x4f\x77\x5f\x71\xb0\x2f\xc7\x8c\xee\xda\x77\x00\x7d\xad\x21\xf6\xdd\x26\x37\xef\x88\x5c\xb1\x7e\x86\xf3\x44\x01\xce\x6c\xf4\x1d\x05\x5e\xa6\x3c\x03\xfd\x9c\x4e\x5e\x9b\x50\x1c\x49\x26\x15\x27\xb3\x77\x68\x20\xee\x81\x02\x82\x01\x01\x00\xe9\x7b\xc6\xd2\xff\x46\x90\x1e\xfa\x11\x71\xcb\xa6\x92\x5e\x0f\x8d\x68\xc6\x85\x74\xe3\x49\x98\x48\x2a\x75\xfd\x42\x8b\x69\x61\xf0\x77\x71\xc7\xaf\x8e\x41\x05\x2d\x16\xff\xc4\x8d\x55\x31\x8c\xa3\x40\xfa\x5c\x02\x3f\xd5\xa8\xae\x4c\x6d\x48\x0c\xad\xe3\xd0\x4f\x40\x9f\xfa\xed\xee\x1f\xcc\x23\x75\xab\x3e\xc5\xa3\xd1\x87\xa3\xed\x85\x96\x9a\x55\x26\x21\x72\xcb\xe8\x09\xc5\x78\x0a\xe6\xda\xd0\x2f\x0c\xda\xcb\x07\x8d\x77\xa4\x14\x6c\x72\x2a\xf8\x7e\x82\x6d\xfe\x9e\x8f\x7f\xdb\x7d\xf8\x3b\x1d\x8e\x13\xf1\xa4\x82\xd6\x10\xe6\x07\x85\x4e\x0c\xf7\x95\x2d\x59\x28\xa4\xe1\x85\x21\xb8\x9b\x30\x64\xac\xff\x2b\x25\xb3\x5c\x97\x85\x75\xbc\x46\xe5\x0b\xae\xf5\x3d\xc3\x6b\x9b\xf2\xec\x54\x51\xab\xe5\x50\x8f\x3f\x32\x25\xd0\x19\x2f\xd4\x78\xbf\xf6\x4a\xd2\x07\x38\x36\x54\x3f\x19\x6d\x6f\x0a\x8b\xaa\xd7\xa6\x7c\x8f\x26\xf6\xc6\xf4\x58\x0c\x9e\x67\x02\x11\x6d\xd5\x05\x23\xad\x79\x60\x4a\x4d\x33\xcf\x82\x89\x96\x87\xe3\xf4\x5f\x5f\x68\xc2\xd6\x56\xca\x40\x2d\xd4\x7a\xd8\x66\x7c\x17\x5e\x5f\x53\x80\xa5\xce\x0c\xf4\x89\x31\x34\x55\x02\x82\x01\x01\x00\xd3\x09\xc9\xd1\x59\x00\x6a\x25\xd9\xa4\x76\x4f\x10\xad\xdb\xb0\xc0\x94\x23\x37\xa9\x11\x20\x71\x03\x7f\xae\x1f\xf3\x1c\x4a\xff\xb6\xdc\x74\x85\xc2\xf1\xa7\x73\xc2\x29\x83\xac\x68\xd8\xef\x64\x97\x9c\x9c\xce\xc7\xc5\x92\x9d\x98\x24\x96\x15\x45\xd0\xb0\xa4\xeb\xde\x56\x59\xba\x33\xc1\x15\xcc\xd7\x74\xd0\xd3\x3e\x4d\x90\x37\xb1\x2e\x77\x1c\xbb\xfe\x2f\x44\x57\xc4\x85\x9f\x08\x67\x66\x6f\x1e\x28\x02\x5b\x48\x66\x57\x8b\x0a\x5a\xb9\xa1\x5f\x81\x78\x22\x1d\x45\xc5\x00\xdd\xe5\x73\x5c\x1d\x47\x54\x0c\xa9\x5a\x01\x86\x3e\x81\x6d\x82\x09\xa2\x41\x5b\x79\x6f\x6c\xd7\xb1\x79\x04\xc4\x71\x2a\x6f\x6f\xfd\x30\xcc\xc7\x7c\x59\x8f\xbe\xd4\xef\x75\x7c\x8e\x2e\xdc\x40\xbe\x0d\x6f\xe6\x8d\x8c\x84\x3f\xb8\xeb\x2c\xa5\xd7\x2e\x05\x7c\x9f\x73\x06\x7b\x87\xb1\x91\xcf\x38\xa7\x94\x7a\x9f\x5c\xad\x6f\xfe\x66\xac\x16\xe9\x92\x48\x56\x47\x4e\x8b\xb5\x77\xf6\xc4\xc9\x7a\x66\xb9\x25\x57\xe5\x90\x6d\xb3\x6e\x7d\xd1\x7e\xaa\x59\xba\x6c\x71\xc5\x15\xaa\x8e\x27\x6a\x23\xa4\x0f\xd1\x95\xe4\x73\xb5\x7d\x6f\xa3\x6b\x79\xd1\xc2\x06\xc1\x46\x71\x02\x82\x01\x00\x66\x53\x5a\xd5\xca\x0e\xf0\xc6\xc2\xad\xb6\x83\x9c\x22\xf5\x9a\x37\x4d\x3e\x03\xeb\x30\x59\x66\xa5\xea\x05\xff\xd2\x94\x2a\xc1\x43\x93\xf5\x87\xa0\x46\xe5\xf4\x10\xc8\xcd\x9b\x24\x9d\xbb\xb3\x79\x30\xd7\x08\x4f\xec\x0e\x05\x79\x2e\x01\x8e\xdc\x0f\xb1\x91\xef\xc9\xd0\xd3\x36\x47\x70\x24\x15\x3e\x52\xa8\x96\x11\xaf\x98\x94\x9d\x5a\x38\xa0\xb6\xc4\x99\x50\x28\x51\x2f\x47\x1d\xcf\x19\x51\xb8\x7f\x86\x50\xb5\x3e\x40\x1f\xb9\x07\x42\x67\xde\xb1\x3d\x30\x88\x68\x58\xb1\x67\x45\x98\xb5\x9b\xa2\xde\x4b\x9b\x51\x90\x0d\xa5\x26\x4b\x11\x7f\x1d\x6b\xbc\x33\x3d\xa9\xf4\x68\xe9\xe1\xd7\x78\x1c\x03\x63\x56\x09\x60\xe2\x74\xa7\xeb\x53\xa8\x0a\x22\x03\xb6\xcf\xc0\x1b\xcf\x23\x6f\x99\x67\x72\xcb\xb5\x1a\x53\x4d\x4c\xfb\x09\x72\xa0\x65\xab\xed\xe5\x50\xf1\x2f\x3c\xd1\x82\xa6\x8c\xcc\x4b\x28\x02\x02\x03\xb4\xf1\x4e\x03\xb3\x8f\x8a\x32\xb4\x85\x0f\x7b\xf6\x8b\x7e\x1a\x5c\x82\x80\x79\x54\xd6\xf4\xe7\xf2\xbb\xbd\xff\x1c\x46\x53\x2e\x0b\x49\xa8\x8a\x2c\xe5\x67\xb0\x81\x8e\x29\x8c\x24\xe9\xb5\x39\x71\x5e\x39\x29\xb0\x5a\x17\xf8\x69\x02\x82\x01\x00\x42\x26\xbc\x53\x5a\x01\xae\x44\x45\x0f\xaf\x62\x23\x49\x4c\x27\x00\x86\xae\xef\x60\x98\x94\xc1\xb8\x26\x0a\xaf\xcb\x25\xe0\x40\x7d\xd2\x66\xd8\x12\xfe\x6a\xcd\xf7\x5b\xca\x01\x7e\x30\x1a\x02\x3f\x20\x01\x6b\x33\xe5\xb3\x8a\xa0\xc9\x3f\x1e\x55\xef\x0f\x9f\xf2\xab\x94\x07\xb6\x3d\x48\xd6\x0b\x8a\xb1\xfc\x4f\x6b\x25\x27\x02\xbe\x10\x61\x97\xe9\x39\xc9\x19\x34\x25\xce\xf8\xc5\xca\x9b\xaa\x53\x1a\x99\x7a\x81\x9c\x4a\xee\xb3\x85\x32\xd0\xe9\xbe\x0c\xa9\x2c\xe1\xd4\xd9\xeb\xb4\x63\xcf\xc9\x01\xb5\xcf\xee\x39\xdf\x66\x74\x2b\x5f\xe7\x36\x1b\xdd\x3e\xce\x36\xe6\x38\x4a\x52\x33\xf3\x5b\xc1\xc0\x82\xab\x2b\xe3\xd4\xd8\x1e\xbe\xd7\x43\xa9\xf7\xfa\xde\x1a\xc4\x41\xab\x11\x4d\x35\x48\xc3\x76\x24\xff\x53\x00\x80\xcf\x8d\x86\x7c\xc5\x02\x6a\x52\xc8\x7b\x19\xc8\x89\xea\xc5\xb9\x16\x41\x17\xc0\x96\x4f\x1a\xbc\x67\xe4\xc9\xb5\xf9\xce\x1e\x2e\xf8\xf6\xaa\x42\xb9\x92\x7f\x90\xbc\x17\xa2\x89\x30\x88\x7e\xf9\xef\x29\x78\xcc\xdd\xf7\x5f\x9e\xe6\x02\x7f\x4a\x5e\xf7\xab\x59\xb8\x11\x8f\x4f\xa1\x8d\x1f\xfd\xad\x86\xd9\xba\x02\x55\x91\x02\x82\x01\x00\x59\xea\x60\x2e\xb7\x01\xf6\xb1\xe9\xc4\x97\x32\xdb\x52\x9b\x6b\x3f\xf5\x28\x0e\xff\x8e\x7f\x77\xdb\x86\xec\x02\x2c\xa3\xde\x19\x19\x88\x0e\xd9\x3a\x96\xa5\xb3\xe7\xa5\x3a\x6d\x23\x28\x82\x2b\xa0\xa6\x06\xba\x2c\xc6\x95\xd3\x3c\x23\xec\x85\x1d\xd0\xf3\x82\xdc\xa4\x85\x39\xa1\x8c\xa2\xb3\x06\x77\xb1\x87\x18\x90\x1c\x04\x1d\x4d\x74\xc3\xe9\x64\x3e\xcb\x89\xfc\xe8\x1a\x98\xbc\x97\x52\x84\x3d\xa8\x9d\x44\x05\x62\xb2\x87\xda\x2a\x5a\xaa\xd5\xe1\xdf\x7c\xaa\x2e\xca\xc5\x29\x49\xca\x90\x66\x13\x90\x90\xae\x66\x20\x10\xac\x10\xe2\xa7\x0d\x1b\xf7\x74\xd3\x3d\x4d\x16\x22\x3e\xcb\x4f\x3a\x82\xe0\xdd\x04\x1c\xb1\x1a\x67\xb2\x0a\xcb\x02\x5e\x6c\x75\x7c\xdd\xcf\xc9\xa2\x40\x74\x51\xbc\x1a\x55\x19\x3e\xba\xb8\x9a\x26\x39\xa9\x13\x8b\x13\xb7\x3f\xb5\x2d\x31\x16\x8f\x65\xf0\xbc\xea\xa3\xf3\x5a\x9e\xd7\x23\x51\x76\xc1\x06\x27\x31\x8c\x63\xcb\x5d\x79\x1d\x63\x9a\x63\x53\x63\xc0\x6c\xcb\x83\x44\x88\xae\x83\xc8\x90\x87\x99\xcf\x05\x01\xf0\x9b\xf1\x55\x78\x75\xa4\x79\x5a\x57\x6d\x59\x7f\x04\x3a\xb5\x33\xca\xf7\x97\x03\xb4\xd1\x21";

static int search_keyword_hit(RzSearchKeyword *kw, void *user, ut64 addr) {
	*(ut64 *)user = addr;
	return 1;
}

static int search_keyword_back_hit(RzSearchKeyword *kw, void *user, ut64 addr) {
	RzList *l = (RzList *)user;
	ut64 *v = RZ_NEW (ut64);
	*v = addr;
	rz_list_append (l, v);
	return 1;
}

static bool test_search_keyword_str(void) {
	ut64 res = 0;
	RzSearch *rs = rz_search_new (RZ_SEARCH_KEYWORD);
	rz_search_kw_add (rs, rz_search_keyword_new_str ("AAA", "", NULL, 0));
	rz_search_set_callback (rs, &search_keyword_hit, &res);
	rz_search_begin (rs);
	const char *buffer = "abcdefAAAghi";
	rz_search_update_i (rs, 0LL, (ut8*)buffer, strlen(buffer));
	rz_search_free (rs);
	mu_assert_eq (res, 6, "AAA can be found after 6 chars");
	mu_end;
}

static bool test_search_keyword_str_back(void) {
	RzList *res = rz_list_newf ((RzListFree)free);
	RzSearch *rs = rz_search_new (RZ_SEARCH_KEYWORD);
	rs->bckwrds = true;
	rz_search_kw_add (rs, rz_search_keyword_new_str ("ABC", "", NULL, 0));
	rz_search_set_callback (rs, &search_keyword_back_hit, res);
	rz_search_begin (rs);
	// FIXME: as it is just a search, the buffer should be constant, but
	// backwards search requires non-const
	char buffer[] = "123456ABCdefghiABCDExxxx";
	// FIXME: this should not be necessary from an API PoV
	rz_search_string_prepare_backward (rs);
	rz_search_update_i (rs, strlen(buffer), (ut8*)buffer, strlen(buffer));
	rz_search_free (rs);
	mu_assert_eq (rz_list_length (res), 2, "two ABC were found");
	mu_assert_eq (*(ut64 *)rz_list_get_n (res, 0), 15, "first it finds the last ABC");
	mu_assert_eq (*(ut64 *)rz_list_get_n (res, 1), 6, "then it finds the first ABC");
	rz_list_free (res);
	mu_end;
}

static bool test_search_keyword_hex(void) {
	ut64 res = 0;
	RzSearch *rs = rz_search_new (RZ_SEARCH_KEYWORD);
	rz_search_kw_add (rs, rz_search_keyword_new_hex ("414141", "", NULL));
	rz_search_set_callback (rs, &search_keyword_hit, &res);
	rz_search_begin (rs);
	const char *buffer = "abcdefAAAghi";
	rz_search_update_i (rs, 0LL, (ut8*)buffer, strlen(buffer));
	rz_search_free (rs);
	mu_assert_eq (res, 6, "AAA can be found after 6 chars");
	mu_end;
}

static bool test_search_keyword_regexp(void) {
	// FIXME: RzSearch should be smart enough to know when to use regexp and
	// when regular "keyword" search, because the API is a "keyword" API.
	ut64 res = 0;
	RzSearch *rs = rz_search_new (RZ_SEARCH_REGEXP);
	rz_search_kw_add (rs, rz_search_keyword_new_regexp ("/A[^A]A/", NULL));
	rz_search_set_callback (rs, &search_keyword_hit, &res);
	rz_search_begin (rs);
	const char *buffer = "abcAAAdefA3Ajjj";
	rz_search_update_i (rs, 0LL, (ut8*)buffer, strlen(buffer));
	rz_search_free (rs);
	mu_assert_eq (res, 9, "AAA should be skip, A3A found");
	mu_end;
}

static bool test_search_string(void) {
	ut64 res = 0;
	RzSearch *rs = rz_search_new (RZ_SEARCH_STRING);
	// FIXME: There is no reason to have a Keyword set for these kind of search
	rz_search_kw_add (rs, rz_search_keyword_new_str ("ff", "", NULL, false));
	rz_search_set_callback (rs, &search_keyword_hit, &res);
	rz_search_begin (rs);
	const char *buffer = "\x90\x90\x90\x01\x02\x03\x61\x62\x63\x44\x04\x05\x06";
	rz_search_update_i (rs, 0LL, (ut8*)buffer, strlen(buffer));
	rz_search_free (rs);
	mu_assert_eq (res, 6, "ABCD should be found");
	mu_end;
}

static bool test_search_aes(void) {
	ut64 res = UT64_MAX;
	RzSearch *rs = rz_search_new (RZ_SEARCH_AES);
	// FIXME: There is no reason to have a Keyword set for these kind of search
	rz_search_kw_add (rs, rz_search_keyword_new_hexmask ("00", NULL));
	rz_search_set_callback (rs, &search_keyword_hit, &res);
	rz_search_begin (rs);
	const char buffer[] = "\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17";
	rz_search_update_i (rs, 0LL, (ut8*)buffer, sizeof(buffer));
	rz_search_free (rs);
	mu_test_status = MU_TEST_BROKEN;
	mu_assert_eq (res, 3, "AES 128 bit key should be found");
	mu_end;
}

static bool test_search_priv_key(void) {
	ut64 res = UT64_MAX;
	RzSearch *rs = rz_search_new (RZ_SEARCH_PRIV_KEY);
	// FIXME: There is no reason to have a Keyword set for these kind of search
	rz_search_kw_add (rs, rz_search_keyword_new_hexmask ("00", NULL));
	rz_search_set_callback (rs, &search_keyword_hit, &res);
	rz_search_begin (rs);
	rz_search_update_i (rs, 0LL, (ut8*)rsa_private_4096, sizeof(rsa_private_4096));
	rz_search_free (rs);
	mu_assert_eq (res, 0xd, "RSA private key found");
	mu_end;
}

static bool test_search_deltakey(void) {
	// FIXME: RzSearch should be smart enough to know when to use deltakey and
	// when regular "keyword" search, because the API is a "keyword" API.
	ut64 res = UT64_MAX;
	RzSearch *rs = rz_search_new (RZ_SEARCH_DELTAKEY);
	rz_search_kw_add (rs, rz_search_keyword_new_hexmask ("0000", NULL));
	rz_search_set_callback (rs, &search_keyword_hit, &res);
	rz_search_begin (rs);
	const char *buffer = "abcdefAAAghi";
	rz_search_update_i (rs, 0LL, (ut8*)buffer, strlen(buffer));
	rz_search_free (rs);
	mu_assert_eq (res, 6, "3 characters equal are AAA");

	res = UT64_MAX;
	rs = rz_search_new (RZ_SEARCH_DELTAKEY);
	rz_search_kw_add (rs, rz_search_keyword_new_hexmask ("010203", NULL));
	rz_search_set_callback (rs, &search_keyword_hit, &res);
	rz_search_begin (rs);
	buffer = "XXXabdgefAAAghi";
	rz_search_update_i (rs, 0LL, (ut8*)buffer, strlen(buffer));
	rz_search_free (rs);
	mu_assert_eq (res, 3, "4 characters with the specified diff are abdg");

	mu_end;
}

static bool test_search_magic(void) {
	ut64 res = 0;
	RzSearch *rs = rz_search_new_magic (NULL);
	rz_search_set_callback (rs, &search_keyword_hit, &res);
	rz_search_begin (rs);
	const char *buffer = "Hello" "\x7f" "ELFWorld";
	rz_search_update_i (rs, 0LL, (ut8*)buffer, strlen(buffer));
	rz_search_free (rs);
	mu_test_status = MU_TEST_BROKEN;
	mu_assert_eq (res, 5, "\\x7fELF magic can be found after 5 chars");
	mu_end;
}

int all_tests() {
	mu_run_test (test_search_keyword_str);
	mu_run_test (test_search_keyword_str_back);
	mu_run_test (test_search_keyword_hex);
	mu_run_test (test_search_keyword_regexp);
	mu_run_test (test_search_string);
	mu_run_test (test_search_aes);
	mu_run_test (test_search_priv_key);
	mu_run_test (test_search_deltakey);
	mu_run_test (test_search_magic);
	return tests_passed != tests_run;
}

int main(int argc, char **argv) {
	return all_tests ();
}